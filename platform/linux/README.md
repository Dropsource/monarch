# Monarch on Linux

This directory contains code for the Monarch Window Manager on Linux.

_The [Monarch Architecture](https://github.com/Dropsource/monarch/wiki/Monarch-Architecture)_ 
_document provides an overview of the Monarch Window Manager. The sections below provide_
_more details of the Window Manager on Linux._

## The Monarch Window Manager on Linux
- Is a windowless native process
- Uses C++, GTK APIs and Flutter Linux libraries.
- Launches the Controller and Preview windows using the platform APIs.
- Handles the native window interactions like resize, move, docking, window title, etc.
- The source code is built using multiple Flutter versions. For each Flutter version, 
  there will be an executable `monarch_linux_app`, which is distributed to the
  `out/monarch/bin/cache/monarch_ui/flutter_linux_*` directories.
  
## Sub-directories
The platform/linux directory has the following sub-directories:

- build
- gen
- gen_seed
- src

The `build`, `gen` and `gen_seed` directories are generated by the `dart tools/build_platform.dart`
build script. Do not modify these directories by hand.

The `src` directory is where the Monarch source code for Linux lives. Source 
files in the `src` directory include sources in the `gen` directory. 

## Contributing
You can set up your local development environment following this
[guide](https://github.com/Dropsource/monarch/wiki/Setting-up-your-local-development-environment)

You can use Visual Studio Code to make changes to the Monarch Linux code.
You would need the [C++ extension for VS Code](https://marketplace.visualstudio.com/items?itemName=ms-vscode.cpptools).

### Contributing simple changes
If the change you need to make is simple, then these workflow may suffice:

- Modify the source files that need changes inside the src directory
- Then run `dart tools/build_platform.dart`
- Then include `out/monarch/bin` in your path and run monarch using a test project
- Test your changes

### Include paths
If you would like to include paths to make your VS Code experience nicer then you
can use this `.vscode/c_cpp_properties.json` example:
```json
{
    "configurations": [
        {
            "name": "Linux",
            "includePath": [
                "${workspaceFolder}/**",
                "/usr/include/gtk-3.0",
                "/usr/include/gio-unix-2.0",
                "/usr/include/cairo",
                "/usr/include/pango-1.0",
                "/usr/include/harfbuzz",
                "/usr/include/pango-1.0",
                "/usr/include/fribidi",
                "/usr/include/harfbuzz",
                "/usr/include/gdk-pixbuf-2.0",
                "/usr/include/x86_64-linux-gnu",
                "/usr/include/cairo",
                "/usr/include/pixman-1",
                "/usr/include/uuid",
                "/usr/include/freetype2",
                "/usr/include/libpng16",
                "/usr/include/graphene-1.0",
                "/usr/lib/x86_64-linux-gnu/graphene-1.0/include",
                "/usr/include/libmount",
                "/usr/include/blkid",
                "/usr/include/glib-2.0",
                "/usr/lib/x86_64-linux-gnu/glib-2.0/include",
                "/PATH/TO/monarch/platform/linux/gen/flutter/ephemeral/flutter_linux"
            ],
            "defines": [],
            "compilerPath": "/usr/bin/clang",
            "cStandard": "c17",
            "cppStandard": "c++14",
            "intelliSenseMode": "linux-clang-x64"
        }
    ],
    "version": 4
}
```
Replace `/PATH/TO/` in `/PATH/TO/monarch/platform/linux/gen/flutter/ephemeral/flutter_linux` above.

### Monarch Linux version
To modify the Monarch Linux version, go to 
`platform/linux/build_settings.yaml`.

The build script uses the values in build_settings.yaml to set the expected version.


### Formating
Install VS Code extension 
[Clang-Format](https://marketplace.visualstudio.com/items?itemName=xaver.clang-format).
The Monarch Linux C++ source code uses the Google style.

Formatting settings example in settings.json:
```json
{
    "[cpp]": {
        "editor.defaultFormatter": "xaver.clang-format"
    },
    "clang-format.executable": "/home/USER/.vscode/extensions/ms-vscode.cpptools-1.13.9-linux-x64/LLVM/bin/clang-format",
    "clang-format.fallbackStyle": "Google",
}
```

## Debugging
You can use Visual Studio Code to debug the Monarch Linux code. To debug with 
Visual Studio Code you will attach to a running instance of Monarch.

Use `dart tools/build_platform.dart` to build your changes. 
This command will build `monarch_linux_app` executables for every flutter version
you have declared in `tools/local_settings.yaml`. These executables will be placed 
in the `out/monarch/bin/cache/monarch_ui/flutter_linux_*` directories.

You will attach to a `monarch_linux_app` executable.

### VS Code configuration
Create a `.vscode/launch.json` file.
Here is a launch.json configuration example to attach to Monarch:
```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Monarch Attach",
            "type": "cppdbg",
            "request": "attach",
            "program": "${workspaceFolder}/out/monarch/bin/cache/monarch_ui/flutter_linux_VERSION-CHANNEL/monarch_linux_app",
            "MIMode": "gdb",
            "setupCommands": [
                {
                    "description": "Enable pretty-printing for gdb",
                    "text": "-enable-pretty-printing",
                    "ignoreFailures": true
                },
                {
                    "description": "Set Disassembly Flavor to Intel",
                    "text": "-gdb-set disassembly-flavor intel",
                    "ignoreFailures": true
                }
            ]
        }
    ]
}
```
In the example above you would have to change `flutter_linux_VERSION-CHANNEL`
for the directory of the flutter version you are using to test.

VS Code docs:
- [Configure C/C++ debugging](https://code.visualstudio.com/docs/cpp/launch-json-reference)
- [Debugging](https://code.visualstudio.com/docs/editor/debugging)

### Steps to debug
1. Make your code changes
2. Run `dart tools/build_platform.dart`
3. Go to the flutter project you want to use to debug and then run 
   `monarch run -v` on that project
4. Wait for the Monarch windows to show then go to VS Code
5. From VS Code, go to the "Run and Debug" view, select "Monarch Attach" in 
   the dropdown, and hit "Start Debugging (F5)". A search box will show up, 
   type "monarch" and select "monarch_linux_a".
6. The VS Code Terminal may ask you to grant sudo permissions to attach to a process.

Your breakpoints should now hit as you exercise the Monarch app. 
Be careful to only edit files that are part of the src directory.

### Debugging the startup
The process above won't let you debug the Linux startup code which launches the 
Monarch windows manager. If you need to debug the startup code, you can try adding a timer 
to the main function, which should give you enough time to attach to the 
`monarch_linux_app` process.

## How the Monarch Linux build works
The Monarch Linux build is very similar to the Monarch Windows build. The section 
"How the Monarch Windows build works" in platform/windows/README.md should give you
a good idea on how the Monarch Linux build works.


## Learn GTK
Below are the GTK libraries we use in Monarch.

### GTK
GTK is the primary library used to construct user interfaces. It provides user interface controls and signal callbacks to respond to user actions.

[GTK API reference](https://docs.gtk.org/gtk4/)

### GLib
GLib provides the core application building blocks for libraries and applications written in C. It provides common data types used in GTK, the main loop implementation, and a large set of utility functions for strings and general portability across different platforms.

[GLib API reference](https://docs.gtk.org/glib/)


### GObject
GObject provides the object system used by GTK, i.e. how the type system works.

[GObject API reference](https://docs.gtk.org/gobject/)



