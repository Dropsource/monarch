# Monarch on Windows 

This directory contains code for the Monarch Window Manager on Windows.

## The Monarch Window Manager on Windows
- Is a windowless native process
- Uses C++, Win32 APIs and Flutter Windows libraries.
- Launches the Controller and Preview windows using the platform APIs.
- Handles the native window interactions like resize, move, docking, window title, etc.
- The source code is built using multiple Flutter versions. For each Flutter version, 
  there will be an executable monarch_windows_app.exe, which is distrubuted to the
  `out\monarch\bin\cache\monarch_ui\flutter_windows_*` directories.
  
## Sub-directories
The platform/windows directory has the following sub-directories:

- build
- gen
- gen_seed
- src

The `build`, `gen` and `gen_seed` directories are generated by the `dart tools\build_platform.dart`
build script. Do not modify these directories by hand.

The `src` directory is where the Monarch source code for Windows lives. Source 
files in the `src` directory include sources in the `gen` directory. 

## Monarch Windows version and app icon
To modify the Monarch Windows version or the app icon, go to 
`platform\windows\build_settings.yaml`.

The build script uses the values in build_settings.yaml to set the expected version and 
app icon.

## Modify the app icon
- Get a PNG of the monarch logo at 256x256
- Then use ffmpeg to generate an ico file from it. The macos ico format does not work, 
  thus use ffmpeg.
- `ffmpeg -i icon_256x256.png monarch_icon.ico`
- Then copy the output file and use it to replace `platform\windows\src\resources\monarch_app_icon.ico


## Contributing simple changes
If the change you need to make is simple, then these workflow may suffice:

- Modify the source files that need changes inside the src directory
- Then run `dart tools\build_platform.dart`
- Then include `out\monarch\bin` in your path and run monarch using a test project
- Test your changes

## Debugging
You can use Visual Studio to debug Monarch. To debug with Visual Studio you will need paths
to a controller bundle and a preview (or project) bundle. 

The high-level workflow is:

1. Build your code changes using a single Flutter SDK
2. Get controller and preview bundle paths
3. Debug using Visual Studio

### Build your code changes
To simplify your debugging context and to avoid obscure issues, build the code 
using one Flutter SDK.
To do so, go to `tools\local_settings.yaml` and make sure that only one Flutter SDK is 
declared under `local_flutter_sdks`.

Run `dart tools\build_platform.dart` to build your changes. 
This command generates a `platform\windows\build\flutter_windows_*` 
directory. The `flutter_windows_*` directory will have a `monarch_windows_app.sln` 
which is the VS solution file we will use to debug.

### Get controller and preview bundle paths
An easy way to get controller and preview bundles is to run `monarch run -v` on a test 
project. Once that commands launches Monarch on a test project, you can kill Monarch. Then,
open the log file it generated and search for `task_command="monarch_windows_app.exe`.

You should be able to find a log entry of the command which was executed. Copy the arguments 
of that command. We will use those arguments to debug from Visual Studio. The arguments will 
look like:

```
--controller-bundle C:\Users\USER\development\monarch\out\monarch\bin\cache\monarch_ui\flutter_windows_3.0.1-stable\monarch_controller --project-bundle C:\Users\USERS\development\scratch\TEST_PROJECT\.monarch --log-level ALL
```

### Debug using Visual Studio
Go to the `platform\windows\build\flutter_windows_*` directory which matches the flutter 
version of the controller and preview bundle you will use. Inside that directory open the 
VS solution file `monarch_windows_app.sln`.

Once the solution is open:

- Make the project monarch_windows_app the startup project via "Set as Startup Project". 
- Then go to the menu Debug > monarch_windows_app Debug Properties > Debugging > Command Arguments
- Then set Command Arguments with the arguments you want to use to debug. It should look like
```
--controller-bundle path\to\monarch_controller --project-bundle path\to\project\.monarch --log-level ALL
```

Now you can start debugging (or press F5).

Be careful to only edit files that are part of the src directory.


## How the Monarch Windows build works
To use flutter desktop on Windows, a project needs to include Flutter C++ header 
files and a DLL. Some of these artifacts are distributed with the Flutter SDK, 
while others are fetched via `flutter precache`. Also, there are very convenient C++ 
source files which simplify the usage of the API. These convenient source files 
are generated by `flutter create`.

The Monarch Windows build script automates the fetching and generation of all
these artificats. This automation runs for each Flutter SDK 
version the build machine (or local machine) supports.

The Monarch windows build generates a sample project via `flutter create` for 
each Flutter SDK on the build machine. This sample project is the `gen_seed`. 
The build script then copies parts of the `gen_seed` to the `gen` directory.

The CMakeLists.txt file which includes the `src` files is in 
`gen\runner\CMakeLists.txt`. The build script modifies it to include Monarch 
C++ source files. 

_The are multiple `gen_seed\flutter_windows_*` directories. There is only_ 
_one `gen` and `src` directories._

Also, due to the generation above, the version number and app icon need to be 
declared elsewhere, hence the need for the `platform\windows\build_settings.yaml`.

Once the build has the gen directory ready, it runs `CMake` commands. These 
commands generate Visual Studio solution files which let us debug Monarch using 
any Flutter version. The VS solution files are in the `build` directory.

_The are multiple `build\flutter_windows_*` directories._

At the end, once CMake completes, the build script copies 
the files we need to the out directory.

The above build pipeline should be mostly reusable on Linux.

Thus, the windows monarch build is complex because:

- We need to build for multiple flutter sdk versions
- Each flutter version has its own set of DLL, C++ header and source files we want to use
- Some artifacts we need are distributed with the Flutter SDK
- Some artifacts we need are fetch via `fltuter precache`
- Some of these source files we need are generated by `flutter create` 
- The Monarch C++ source files need to be built against every flutter version
- We want to use CMake to build the code because that is what Linux uses as well


## Sign commits
To sign commits on windows install gpg4win, which installs Kleopatra (the frontend of gpg)
which runs the gpg agent. Make sure Kleopatra is running when signing commits.
