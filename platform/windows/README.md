# Monarch on Windows 

This directory contains code for the Monarch Window Manager on Windows.

_The [Monarch Architecture](https://github.com/Dropsource/monarch/wiki/Monarch-Architecture)_ 
_document provides an overview of the Monarch Window Manager. The sections below provide_
_more details of the Window Manager on Windows._

## The Monarch Window Manager on Windows
- Is a windowless native process
- Uses C++, Win32 APIs and Flutter Windows libraries.
- Launches the Controller and Preview windows using the platform APIs.
- Handles the native window interactions like resize, move, docking, window title, etc.
- The source code is built using multiple Flutter versions. For each Flutter version, 
  there will be an executable monarch_windows_app.exe, which is distributed to the
  `out\monarch\bin\cache\monarch_ui\flutter_windows_*` directories.
  
## Sub-directories
The platform/windows directory has the following sub-directories:

- build
- gen
- gen_seed
- src

The `build`, `gen` and `gen_seed` directories are generated by the `dart tools\build_platform.dart`
build script. Do not modify these directories by hand.

The `src` directory is where the Monarch source code for Windows lives. Source 
files in the `src` directory include sources in the `gen` directory. 

## Monarch Windows version and app icon
To modify the Monarch Windows version or the app icon, go to 
`platform\windows\build_settings.yaml`.

The build script uses the values in build_settings.yaml to set the expected version and 
app icon.

## Modify the app icon
- Get a PNG of the monarch logo at 256x256
- Then use ffmpeg to generate an ico file from it. The macos ico format does not work, 
  thus use ffmpeg.
- `ffmpeg -i icon_256x256.png monarch_icon.ico`
- Then copy the output file and use it to replace `platform\windows\src\resources\monarch_app_icon.ico


## Contributing simple changes
If the change you need to make is simple, then these workflow may suffice:

- Modify the source files that need changes inside the src directory
- Then run `dart tools\build_platform.dart`
- Then include `out\monarch\bin` in your path and run monarch using a test project
- Test your changes

## Debugging
You can use Visual Studio to debug the Monarch Windows code. To debug with 
Visual Studio you will attach to a running instance of Monarch.

Use `dart tools\build_platform.dart` to build your changes. 
This command generates a `platform\windows\build\flutter_windows_*` 
directory, where the `*` represents every flutter version you have declared in `tools\local_settings.yaml`. 
The `flutter_windows_*` directory will have a `monarch_windows_app.sln` 
which is the VS solution file we will use to debug.

### Steps to debug
1. Make your code changes
2. Run `dart tools\build_platform.dart`
3. Go to the flutter project you want to use to debug and then run `monarch run -v` on that project
4. Wait for the Monarch windows to show then go to `platform\windows\build\flutter_windows_*\monarch_windows_app.sln`
5. From Visual Studio, click Debug > Attach to Process, then search for the `monarch_windows_app.exe` process and click Attach

Your breakpoints should now hit as you exercise the Monarch app. 
Be careful to only edit files that are part of the src directory.

### Debugging the startup
The process above won't let you debug the Windows startup code which launches the 
Monarch windows. If you need to debug the startup code, then you can add a timer in the main
function. There is a commented out piece of code which will put the main thread to sleep
for 10 seconds (see main.cpp). If you uncomment that piece of code, then when the application 
starts, it will sleep for 10 seconds, 
which should give you enough time to attach to the `monarch_windows_app.exe` process.

## How the Monarch Windows build works
To use flutter desktop on Windows, a project needs to include Flutter C++ header 
files and a DLL. Some of these artifacts are distributed with the Flutter SDK, 
while others are fetched via `flutter precache`. Also, there are very convenient C++ 
source files which simplify the usage of the API. These convenient source files 
are generated by `flutter create`.

The Monarch Windows build script automates the fetching and generation of all
these artifacts. This automation runs for each Flutter SDK 
version the build machine (or local machine) supports.

The Monarch windows build generates a sample project via `flutter create` for 
each Flutter SDK on the build machine. This sample project is the `gen_seed`. 
The build script then copies parts of the `gen_seed` to the `gen` directory.

The CMakeLists.txt file which includes the `src` files is in 
`gen\runner\CMakeLists.txt`. The build script modifies it to include Monarch 
C++ source files. 

The build script may also set preprocessor directives on the `gen\runner\CMakeLists.txt`
file. We use preprocessor directives when there are API changes so the C++
code can compile with different flutter versions.

_The are multiple `gen_seed\flutter_windows_*` directories. There is only_ 
_one `gen` and `src` directories._

Also, due to the generation above, the version number and app icon need to be 
declared elsewhere, hence the need for the `platform\windows\build_settings.yaml`.

Once the build has the gen directory ready, it runs `CMake` commands. These 
commands generate Visual Studio solution files which let us debug Monarch using 
any Flutter version. The VS solution files are in the `build` directory.

_The are multiple `build\flutter_windows_*` directories._

At the end, once CMake completes, the build script copies 
the files we need to the out directory.

The above build pipeline should be mostly reusable on Linux.

Thus, the windows monarch build is complex because:

- We need to build for multiple flutter sdk versions
- Each flutter version has its own set of DLL, C++ header and source files we want to use
- Some artifacts we need are distributed with the Flutter SDK
- Some artifacts we need are fetch via `fltuter precache`
- Some of these source files we need are generated by `flutter create` 
- The Monarch C++ source files need to be built against every flutter version
- We want to use CMake to build the code because that is what Linux uses as well
- We may need to set preprocessor directives so the C++ code can compile with different 
  flutter versions


## Sign commits
To sign commits on windows install gpg4win, which installs Kleopatra (the frontend of gpg)
which runs the gpg agent. Make sure Kleopatra is running when signing commits.


## Preview and Controller Mode
The code supports running the window manager in two modes: preview and controller. 
At runtime, the Monarch CLI runs two processes of this window manager. One in preview mode
which hosts the preview api and preview window. And the other one in controller mode, which
hosts the controller window. We run two processes because Flutter on Windows 
[has an issue](https://github.com/flutter/flutter/issues/110661) running two windows in the 
same process.